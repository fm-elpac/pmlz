# pmlc

胖喵小云: 超小个人云的软硬件技术方案

正式名称: 紫腹巨蚊 (Toxorhynchites gravelyi) 系列 蘑菇 (Agaricus campestris) 系统

在本地使用几台廉价的计算机硬件, 组建一个云计算集群.
在低成本以及管理能力上具有很明显的优势.


## 主要架构设计

+ (硬件) 主服务器集群: 支持 1 ~ 10 台服务器

  建议的标准配置: 2U 双路服务器 (12 个 3.5 英寸盘位) 1 台

  优点: 扩展能力极强, 成本低 (高性价比)

  高配: 建议使用机柜, 2U 服务器 2 台及以上 (高可用集群)

  ----

  网络 (局域网): 千兆以太网 (中心交换机支持 802.1q VLAN, 链路聚合)

  高配: 10G 光纤以太网

  ----

  建议的最低硬件配置:

  - 服务器 (或 PC) 1 台

  - CPU: E5-26XXv4, 8 核及以上

  - 内存: 32GB, DDR4

  - 系统盘: SSD 500GB x1

  - 数据盘: 机械 4TB 3.5 英寸 SATA x2

+ (可选, 硬件) 副服务器 (SBC)

  建议硬件: 香橙派 5 (处理器 rk3588, 内存 16GB)

  作用:

  - 用于连接 IoT 设备 (IoT 设备接入网关, wifi 接入)

  - 作为局域网 DNS 服务器 (adguardhome)

  - 当主服务器集群故障时, 能够在一定程度上维持 胖喵小窝 的基本运行
    (而不是完全失去功能)

  - 当主服务器集群只有 2 台服务器时, 作为 `etcd` 服务器
    (凑够 3 台集群)

+ (软件) 主服务器集群 (物理机): 主要提供虚拟机

  操作系统: Fedora CoreOS (基于 rpm-ostree)

  虚拟机: libvirt, QEMU/KVM

  胖喵小云管理软件 (pmlc-s)

+ (虚拟机) 数据库服务器 (胖喵小窝 主数据库)

  数据库: PostgreSQL (pigsty)

+ (虚拟机) 容器服务器: 胖喵小云 k8s 主集群

+ (虚拟机) object 存储服务器 (minio ?)


## 默认维护时间窗口

服务器 (Fedora CoreOS) 自动更新重启时间.

+ 周二 (Tue), 周四 (Thu), 周日 (Sun)

+ 北京时间 `11:00` ~ `13:00` (UTC+0800, CST)

为什么选择这个时间窗口用于维护 ?

+ 相对于 胖喵小云 的目标使用场景 (个人云, 胖喵小窝),
  工作日这个时间段, 大部分人正在外出上班 (吃午饭/午休),
  并不在家, 所以对 胖喵小云 的使用需求较少 (在很少使用的时间段重启).

+ 如果因为系统更新, 重启后故障 (无法正常工作), 这个故障发生在白天,
  人们有充足的时间/精力/计划空间去处理这个故障, 不影响晚上睡眠.
  反之, 如果大半夜服务器自动重启后故障, 那么需要不睡觉,
  从被窝里爬起来处理这个故障 ?
  至少笔者绝不愿意遇到这种情况.


## k8s 集群安装建议

+ 对于不超过 3 台物理机器 (1, 2, 3) 的 主服务器集群,
  建议安装 k3s: <https://k3s.io/>

  ----

  3 台 2U 服务器集群的最大存储容量估算:

  - 硬盘总数 (数据盘): 12 x3 = 36 块

  - 单盘容量 12TB, 则总容量 (最大) 为: 432TB

  这个集群的硬件购买成本 (廉价二手设备) 约为: 3.2 万元 (CNY)
  (估算时间: 2024-04)

  每月耗电 (24x7 运行) 约 400kWh, 电费约 300 元.
  硬件购买成本大约相当于 100 个月的电费 (8 年).

  以上数据仅为估计, 不保证正确, 仅供参考.

  ----

  由上述成本估计可知, 大部分人构建的 胖喵小云 集群不会超过 3 台服务器.

+ 对于超过 3 台物理机器 (4, 5, 6, .. . ) 的集群,
  建议安装完整的 k8s: <https://kubernetes.io/>


TODO
